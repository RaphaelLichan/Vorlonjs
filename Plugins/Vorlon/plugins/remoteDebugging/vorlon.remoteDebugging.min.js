var __extends=this.__extends||function(e,t){function o(){this.constructor=e}for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);o.prototype=t.prototype,e.prototype=new o},VORLON;!function(e){var t=function(){function e(){}return e}();e.Location=t;var o=function(){function e(){}return e}();e.evaluateOnCallFrame=o;var s=function(s){function r(){s.call(this,"remoteDebugging","control.html","control.css"),this._ready=!1}return __extends(r,s),r.prototype.getID=function(){return"REMOTEDEBUGGER"},r.prototype._markForRefresh=function(){var e=this;this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=setTimeout(function(){e.refresh()},1e4)},r.prototype.refresh=function(){},r.prototype._getTab=function(e){var t=null,o=document.title;return e.forEach(function(e){console.log("checking tab "+e.title),-1!=e.title.indexOf(o)&&(t=e,console.log("tab match "+e.title))}),t},r.prototype._packageJson=function(){var e={type:"json",json:JSON.stringify(this.item)};return e},r.prototype.onRealtimeMessageReceivedFromDashboardSide=function(t){var o,s=this,r=new XMLHttpRequest;if(t&&t.type)switch(t.type){case"getJSON":console.log("trying to get json metadata from browser"),r.open("GET","http://localhost:9222/json",!0),r.withCredentials=!0,r.onreadystatechange=function(){4==r.readyState&&200==r.status?(console.log("json call success "+r.responseText),o=JSON.parse(r.responseText),s.item=s._getTab(o),e.Core.Messenger.sendRealtimeMessage(s.getID(),s._packageJson(),e.RuntimeSide.Client)):console.log("json call failed "+r.readyState+"/"+r.status+"/"+r.responseText)},r.send()}else;},r.prototype.startDashboardSide=function(t){var o=this;void 0===t&&(t=null),this._dashboardDiv=t,this._insertHtmlContentAsync(this._dashboardDiv,function(t){o._containerDiv=t,o._code=o._containerDiv.querySelector("#code"),o._selectScript=o._containerDiv.querySelector("#listScripts"),o._selectScript.innerHTML="",e.Core.Messenger.sendRealtimeMessage(o.getID(),{type:"getJSON",order:null},e.RuntimeSide.Dashboard),o._index=0,o._scriptsParsed=[],o._timeout=null,o._ready=!0})},r.prototype._displayScript=function(e){var t=this;this._scriptsParsed.forEach(function(o){o.scriptId==e&&(t._code.innerHTML=o.scriptSource)})},r.prototype._empty=function(){this._selectScript.innerHTML="",this._scriptsParsed=[],this._timeout=null},r.prototype._connectWithClient=function(e){var t=this;console.log("received json metadata "+e.json);var o=JSON.parse(e.json),s="";o&&o.webSocketDebuggerUrl&&(s=o.webSocketDebuggerUrl,console.log("opening websocket to "+s),this._socket=new WebSocket(s),this._socket.onopen=function(){if(t._socket.readyState===WebSocket.OPEN){var e={method:"Debugger.enable",id:t._index++};console.log("send Debugger.enable"),t._socket.send(JSON.stringify(e))}},this._socket.onerror=function(e){console.error("error from rdp websocket",e)},this._socket.onmessage=function(e){var o={};if(e&&e.data){var s=JSON.parse(e.data);if(console.log("received "+s.method,s),s.method&&"Debugger.scriptParsed"===s.method&&(-1==s.params.url.indexOf("extensions::unload_event")?t._scriptParsed(s):t._empty()),s&&s.result){var r=s.result;if(r.scriptSource){var n=t._scriptsParsed[s.id];n.scriptSource=r.scriptSource,t._timeout||3!=n.startLine||(t._timeout=setTimeout(function(){t._displayScript(+n.scriptId),t._addBreakpoint(n)},1e3))}else r.breakpointId?console.log("Breakpoint added:",r):r.result&&(console.log("Result expression: ",r.result),o={id:t._index++,method:"Debugger.resume"},console.log("send Debugger.resume"),t._socket.send(JSON.stringify(o)))}s.method&&"Debugger.paused"===s.method&&t._debuggerPaused(s)}})},r.prototype._scriptParsed=function(t){var o=document.createElement("li"),s="",r=t.params.url,n=r.substring(0,r.lastIndexOf(".js"));s=""!==n?n.substring(n.lastIndexOf("/")+1,n.length)+".js":r.substring(r.lastIndexOf("/")+1,r.length),o.id=t.params.scriptId,o.innerHTML=s;var i=this;o.addEventListener("click",function(){var t=i._selectScript.querySelector(".selected");t&&t.classList.remove("selected");var o=$(this);e.Tools.AddClass(o[0],"selected"),i._displayScript(o[0].id)}),this._selectScript.appendChild(o);var a=this._index++,c={id:a,method:"Debugger.getScriptSource",params:{scriptId:t.params.scriptId.toString()}};this._scriptsParsed[a]=t.params,console.log("send Debugger.getScriptSource"),this._socket.send(JSON.stringify(c))},r.prototype._addBreakpoint=function(e){this._setBreakPoint(e)},r.prototype._setBreakPoint=function(e){var o=new t;o.columnNumber=0,o.lineNumber=8,o.scriptId=e.scriptId;var s={id:this._index++,method:"Debugger.setBreakpoint",params:{location:o}};console.log("send Debugger.setBreakpoint"),this._socket.send(JSON.stringify(s))},r.prototype._debuggerPaused=function(e){var t=e.params.callFrames[0],s=new o;s.callFrameId=t.callFrameId,s.expression="i + j",s.objectGroup="",s.returnByValue=!0;var r={id:this._index++,method:"Debugger.evaluateOnCallFrame",params:s};console.log("send Debugger.evaluateOnCallFrame"),this._socket.send(JSON.stringify(r))},r.prototype.onRealtimeMessageReceivedFromClientSide=function(e){e&&"json"===e.type&&("null"!==e.json?this._connectWithClient(e):console.log("Failed connection!"))},r}(e.Plugin);e.remoteDebugging=s,e.Core.RegisterPlugin(new s)}(VORLON||(VORLON={}));